name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ============================================================
  # åç«¯æµ‹è¯•å’Œæ£€æŸ¥
  # ============================================================
  backend-test:
    name: Backend Tests & Lint
    runs-on: ubuntu-latest

    services:
      neo4j:
        image: neo4j:5.15.0
        env:
          NEO4J_AUTH: neo4j/test_password
        ports:
          - 7687:7687
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ğŸ“¦ Install backend dependencies
        working-directory: ./web/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black pytest pytest-cov

      - name: ğŸ” Lint with flake8
        working-directory: ./web/backend
        run: |
          # åœæ­¢æ„å»ºå¦‚æœæœ‰è¯­æ³•é”™è¯¯æˆ–æœªå®šä¹‰çš„åç§°
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # å…¶ä»–æ£€æŸ¥ï¼ˆä»…è­¦å‘Šï¼‰
          flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: âœ… Check code formatting with black
        working-directory: ./web/backend
        run: |
          black --check app/ || echo "Code formatting issues detected. Run 'black app/' to fix."

      - name: ğŸ§ª Run backend tests
        working-directory: ./web/backend
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test_password
          NEO4J_DATABASE: neo4j
        run: |
          pytest -v --cov=app --cov-report=xml --cov-report=term

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./web/backend/coverage.xml
          flags: backend
          name: backend-coverage

  # ============================================================
  # å‰ç«¯æµ‹è¯•å’Œæ£€æŸ¥
  # ============================================================
  frontend-test:
    name: Frontend Tests & Lint
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ./web/frontend/package-lock.json

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./web/frontend
        run: npm ci

      - name: ğŸ” Lint with ESLint
        working-directory: ./web/frontend
        run: npm run lint

      - name: ğŸ—ï¸ Build frontend
        working-directory: ./web/frontend
        run: npm run build

      - name: ğŸ§ª Run frontend tests (if any)
        working-directory: ./web/frontend
        run: npm test || echo "No tests configured yet"
        continue-on-error: true

  # ============================================================
  # æ•°æ®å¤„ç†ç®¡é“æ£€æŸ¥
  # ============================================================
  pipeline-check:
    name: Pipeline Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black
          # å®‰è£…ä¸»è¦ä¾èµ–ï¼ˆä¸åŒ…å«æ‰€æœ‰å¯é€‰ä¾èµ–ï¼‰
          pip install -r requirements-minimal.txt || pip install pandas numpy || true

      - name: ğŸ” Lint main pipeline
        run: |
          flake8 *.py --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,archive
          flake8 *.py --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv,archive

      - name: âœ… Check code formatting
        run: |
          black --check *.py --exclude="venv|archive" || echo "Code formatting issues detected"

  # ============================================================
  # Docker æ„å»ºæµ‹è¯•
  # ============================================================
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./web/backend
          push: false
          tags: pwd-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ”¨ Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./web/frontend
          push: false
          tags: pwd-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ§ª Test docker-compose
        run: |
          docker-compose config

  # ============================================================
  # å®‰å…¨æ‰«æ
  # ============================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: ğŸ“Š Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

  # ============================================================
  # æ„å»ºå’Œæ¨é€ Docker é•œåƒï¼ˆä»…åœ¨ main åˆ†æ”¯ï¼‰
  # ============================================================
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: [docker-build, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“ Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/pwd-backend
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha

      - name: ğŸš€ Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./web/backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ“ Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/pwd-frontend
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha

      - name: ğŸš€ Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./web/frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # é€šçŸ¥
  # ============================================================
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, pipeline-check, docker-build]
    if: always()

    steps:
      - name: âœ… Success notification
        if: ${{ needs.backend-test.result == 'success' && needs.frontend-test.result == 'success' }}
        run: echo "âœ… All checks passed!"

      - name: âŒ Failure notification
        if: ${{ needs.backend-test.result == 'failure' || needs.frontend-test.result == 'failure' }}
        run: echo "âŒ Some checks failed. Please review the logs."
